@model List<AnimeStore.Models.CartItem>
@{
    ViewData["Title"] = "Your Cart";
    decimal total = Model?.Sum(i => i.Product.Price * i.Quantity) ?? 0;
}

<div id="anti">@Html.AntiForgeryToken()</div>

<style>
    .cart-wrapper {
        display: flex;
        gap: 24px;
        max-width: 1200px;
        margin: 32px auto;
        padding: 0 16px;
    }

    .cart-container {
        flex: 2;
        background: #1a1a1a;
        border-radius: 10px;
        padding: 20px;
    }

    .summary {
        flex: 1;
        background: #1a1a1a;
        border-radius: 10px;
        padding: 20px;
        height: fit-content;
        position: sticky;
        top: 20px;
    }

    .cart-item {
        display: flex;
        gap: 16px;
        align-items: center;
        border-bottom: 1px solid #333;
        padding: 12px 0;
    }

    .qty {
        margin: 0 8px;
        width: 28px;
        text-align: center;
        display: inline-block;
    }

    .checkout-btn {
        background: #ff6600;
        color: #fff;
        border: none;
        padding: 12px;
        width: 100%;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 12px;
    }

    .clear-btn {
        background: transparent;
        color: #ff6600;
        border: 1px solid #ff6600;
        padding: 10px;
        margin-top: 8px;
        width: 100%;
        border-radius: 6px;
        cursor: pointer;
    }

    #toast {
        position: fixed;
        left: 50%;
        bottom: 30px;
        transform: translateX(-50%);
        background: #333;
        color: white;
        padding: 12px 16px;
        border-radius: 6px;
        display: none;
        z-index: 9999;
    }
</style>

<h1 style="text-align:center;color:#ff6600;margin-top:28px;">Your Cart</h1>

@if (Model == null || !Model.Any())
{
    <p style="text-align:center;color:#ff9c4a;">Your cart is empty.</p>
}
else
{
    <div class="cart-wrapper">
        <div class="cart-container">
            @foreach (var item in Model)
            {
                <div class="cart-item" data-id="@item.Id" data-price="@item.Product.Price">
                    <img src="@item.Product.ImagePath" style="width:100px;height:100px;object-fit:cover;border-radius:8px;" />
                    <div style="flex:1;">
                        <h4 style="color:#ff9c4a;margin:0;">@item.Product.Name</h4>

                        <p style="color:#bbb;margin:6px 0;">
                            ₹@item.Product.Price ×
                            <span class="qty price-qty">@item.Quantity</span>
                            =
                            <b class="item-total">₹@(item.Product.Price * item.Quantity)</b>
                        </p>
                    </div>

                    <div>
                        <div>
                            <button class="decrease">-</button>
                            <span class="qty control-qty">@item.Quantity</span>
                            <button class="increase">+</button>
                        </div>
                        <div style="margin-top:8px;">
                            <button class="remove-btn" style="background:none;border:1px solid #ff4444;color:#ff4444;padding:6px;border-radius:4px;">Remove</button>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="summary">
            <h3 style="color:#ff6600;margin-top:0;">Order Summary</h3>
            <div style="display:flex;justify-content:space-between;margin-top:8px;">
                <div>Subtotal</div><div id="subtotal">₹@total</div>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:8px;">
                <div>Delivery</div><div>Free</div>
            </div>
            <div style="border-top:1px solid #333;padding-top:12px;margin-top:12px;display:flex;justify-content:space-between;font-weight:700;">
                <div>Total</div><div id="total">₹@total</div>
            </div>

            <button class="checkout-btn" onclick="location.href='/Cart/Checkout'">Proceed to Checkout</button>
            <button class="clear-btn" id="clearCartBtn">Clear Cart</button>
        </div>
    </div>
}

<div id="toast"></div>

<script>
    function showToast(msg, color = '#ff6600') {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.style.backgroundColor = color;
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2000);
    }

    function getToken() {
        const input = document.querySelector('#anti input[name="__RequestVerificationToken"]');
        return input ? input.value : '';
    }

    async function postData(url, data) {
        const token = getToken();
        if (token) data.__RequestVerificationToken = token;

        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams(data)
        });

        return res.json();
    }

    function recalcSummary() {
        let total = 0;

        document.querySelectorAll('.cart-item').forEach(i => {
            const price = parseFloat(i.dataset.price);
            const qty = parseInt(i.querySelector('.control-qty').textContent);
            const line = price * qty;

            i.querySelector('.price-qty').textContent = qty;
            i.querySelector('.item-total').textContent = '₹' + line;

            total += line;
        });

        document.getElementById('subtotal').textContent = '₹' + total;
        document.getElementById('total').textContent = '₹' + total;
    }

    document.querySelectorAll('.increase').forEach(btn => btn.addEventListener('click', async e => {
        const parent = e.target.closest('.cart-item');
        const id = parent.dataset.id;
        const qtySpan = parent.querySelector('.control-qty');
        const newQty = parseInt(qtySpan.textContent) + 1;

        const res = await postData('/Cart/UpdateQuantity', { itemId: id, quantity: newQty });

        if (res.success) {
            qtySpan.textContent = newQty;
            recalcSummary();
        }
    }));

    document.querySelectorAll('.decrease').forEach(btn => btn.addEventListener('click', async e => {
        const parent = e.target.closest('.cart-item');
        const id = parent.dataset.id;
        const qtySpan = parent.querySelector('.control-qty');
        const newQty = Math.max(1, parseInt(qtySpan.textContent) - 1);

        const res = await postData('/Cart/UpdateQuantity', { itemId: id, quantity: newQty });

        if (res.success) {
            qtySpan.textContent = newQty;
            recalcSummary();
        }
    }));

    document.querySelectorAll('.remove-btn').forEach(btn => btn.addEventListener('click', async e => {
        const parent = e.target.closest('.cart-item');
        const id = parent.dataset.id;

        const res = await postData('/Cart/RemoveItem', { itemId: id });

        if (res.success) {
            parent.remove();
            recalcSummary();
            showToast('Item removed', '#d9534f');
        }
    }));

    document.getElementById('clearCartBtn')?.addEventListener('click', async () => {
        const res = await postData('/Cart/ClearCart', {});
        if (res.success) location.reload();
    });
</script>
