@model List<AnimeStore.Models.WishlistItem>
@{
    ViewData["Title"] = "Your Wishlist";
}

<!-- Anti-forgery token for JS -->
<div id="anti">@Html.AntiForgeryToken()</div>

<style>
    body {
        background-color: #0d0d0d;
        color: #fff;
        font-family: 'Segoe UI', sans-serif;
    }

    h1 {
        text-align: center;
        color: #ff6600;
        margin-top: 40px;
        margin-bottom: 30px;
        font-weight: 700;
    }

    .wishlist-container {
        max-width: 1000px;
        margin: auto;
        background: #1a1a1a;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }

    .wishlist-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 25px;
        border-bottom: 1px solid #333;
        padding-bottom: 20px;
        gap: 16px;
    }

        .wishlist-item img {
            width: 120px;
            height: 120px;
            border-radius: 8px;
            object-fit: cover;
        }

    .item-details {
        flex: 1;
        margin-left: 20px;
    }

        .item-details h4 {
            color: #ff9c4a;
            font-size: 1.2rem;
            margin: 0;
        }

        .item-details p {
            color: #aaa;
            margin: 6px 0;
        }

    .wishlist-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .move-btn {
        background: #ff6600;
        color: #fff;
        border: none;
        padding: 8px 14px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
    }

    .remove-btn {
        background: transparent;
        color: #ff4444;
        border: 1px solid #ff4444;
        padding: 8px 14px;
        border-radius: 6px;
        cursor: pointer;
    }

    .clear-btn {
        background: transparent;
        border: 1px solid #ff6600;
        color: #ff6600;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        float: right;
    }

    #toast {
        visibility: hidden;
        min-width: 250px;
        background: #333;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 14px;
        position: fixed;
        z-index: 10000;
        left: 50%;
        bottom: 30px;
        transform: translateX(-50%);
        font-weight: 600;
        opacity: 0;
        transition: opacity .25s;
    }

        #toast.show {
            visibility: visible;
            opacity: 1;
        }
</style>

<h1>Your Wishlist</h1>

<div class="wishlist-container">
    @if (Model != null && Model.Any())
    {
        foreach (var item in Model)
        {
            <div class="wishlist-item" data-id="@item.Id" data-product="@item.ProductId">
                <img src="@item.Product.ImagePath" alt="@item.Product.Name" />
                <div class="item-details">
                    <h4>@item.Product.Name</h4>
                    <p>₹@item.Product.Price</p>
                </div>
                <div class="wishlist-actions">
                    <button class="move-btn" data-product="@item.ProductId">Move to Cart</button>
                    <button class="remove-btn" data-id="@item.Id">Remove</button>
                </div>
            </div>
        }

        <div style="margin-top:20px;">
            <button class="clear-btn">Clear Wishlist</button>
        </div>
    }
    else
    {
        <p style="text-align:center; color:#ff9c4a;">Your wishlist is empty.</p>
    }
</div>

<div id="toast"></div>

<script>
    // helper
    function showToast(msg, bg = '#ff6600') {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.style.backgroundColor = bg;
        t.className = 'show';
        setTimeout(() => t.className = t.className.replace('show', ''), 2000);
    }

    function getAntiForgeryToken() {
        const tokenInput = document.querySelector('#anti input[name="__RequestVerificationToken"]');
        return tokenInput ? tokenInput.value : '';
    }

    async function postForm(url, data) {
        const token = getAntiForgeryToken();
        if (token) data.__RequestVerificationToken = token;
        const resp = await fetch(url, {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams(data)
        });
        // try parse json safely
        try { return await resp.json(); } catch { return { success: false }; }
    }

    // Move to cart
    document.querySelectorAll('.move-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const productId = e.target.dataset.product;
            if (!productId) return showToast('Invalid product', '#d9534f');

            const res = await postForm('/Wishlist/MoveToCart', { productId });
            if (res.success) {
                // remove element from DOM
                const parent = e.target.closest('.wishlist-item');
                if (parent) parent.remove();

                showToast('Moved to cart', '#5cb85c');
            } else if (res.message === 'unauthorized') {
                showToast('Please login to continue', '#d9534f');
            } else {
                showToast('Something went wrong', '#d9534f');
            }
        });
    });

    // Remove single
    document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const itemId = e.target.dataset.id;
            if (!itemId) return;
            const res = await postForm('/Wishlist/RemoveItem', { itemId });
            if (res.success) {
                e.target.closest('.wishlist-item').remove();
                showToast('Removed from wishlist', '#d9534f');
            } else {
                showToast('Failed to remove', '#d9534f');
            }
        });
    });

    // Clear wishlist
    document.querySelector('.clear-btn')?.addEventListener('click', async () => {
        const res = await postForm('/Wishlist/ClearWishlist', {});
        if (res.success) {
            document.querySelector('.wishlist-container').innerHTML = "<p style='text-align:center; color:#ff9c4a;'>Your wishlist is empty.</p>";
            showToast('Wishlist cleared', '#5cb85c');
        } else {
            showToast('Failed to clear', '#d9534f');
        }
    });
</script>
